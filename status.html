<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>App Status</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;line-height:1.4;padding:18px;background:#f6f8fb;color:#0b2540}
    .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(11,60,111,0.06)}
    h1{font-size:18px;margin-bottom:8px;color:#0b3c6f}
    pre{background:#f1f5f9;padding:10px;border-radius:6px;overflow:auto}
    .ok{color:green;font-weight:700}
    .warn{color:#b36b00;font-weight:700}
    .err{color:#b00020;font-weight:700}
    button{background:#0b3c6f;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h1>حالة التطبيق المحلي</h1>
    <div id="summary">جارٍ الفحص...</div>
  </div>

  <div class="card">
    <h1>محتويات التخزين المحلي</h1>
    <div><strong>cms_mode:</strong> <span id="mode">-</span></div>
    <div style="margin-top:8px"><strong>cms_users:</strong></div>
    <pre id="users">-</pre>
    <div><strong>cms_movements:</strong></div>
    <pre id="movements">-</pre>
    <div><strong>cms_messages:</strong></div>
    <pre id="messages">-</pre>
  </div>

  <div class="card">
    <h1>سجل آخر خطأ</h1>
    <div id="last">جارٍ التحميل...</div>
    <pre id="lastRaw">-</pre>
  </div>

  <div class="card">
    <h1>إجراءات سريعة</h1>
    <ul>
      <li>إذا كانت القيم فارغة، امسح بيانات الموقع ثم أعد تحميل الصفحة.</li>
      <li>تأكد أن الملفات المحدثة (index.html, main.js, main.css, manifest.json, service-worker.js, al-masaood-logo.png) مرفوعة بنفس الأسماء.</li>
      <li>إذا ظهر خطأ password_mismatch أو user_not_found، أعد تهيئة المستخدمين المحليين عبر استبدال main.js بالنسخة النهائية التي زودتك بها ثم امسح بيانات الموقع.</li>
    </ul>
    <div style="margin-top:8px"><button id="refreshBtn">تحديث الفحص</button></div>
  </div>

  <script>
    function safeParse(v){ try{ return JSON.parse(v); }catch{ return v; } }
    function show() {
      try {
        const mode = localStorage.getItem('cms_mode') || 'unknown';
        document.getElementById('mode').textContent = mode;
        const users = localStorage.getItem('cms_users');
        const mov = localStorage.getItem('cms_movements');
        const msg = localStorage.getItem('cms_messages');
        document.getElementById('users').textContent = users ? JSON.stringify(safeParse(users), null, 2) : '[]';
        document.getElementById('movements').textContent = mov ? JSON.stringify(safeParse(mov), null, 2) : '[]';
        document.getElementById('messages').textContent = msg ? JSON.stringify(safeParse(msg), null, 2) : '[]';
        const last = localStorage.getItem('cms_last_error');
        if (!last) {
          document.getElementById('last').innerHTML = '<span class="ok">لا توجد أخطاء مسجلة</span>';
          document.getElementById('lastRaw').textContent = '-';
        } else {
          try {
            const parsed = JSON.parse(last);
            document.getElementById('last').innerHTML = '<span class="err">يوجد خطأ مسجل</span>';
            document.getElementById('lastRaw').textContent = JSON.stringify(parsed, null, 2);
          } catch {
            document.getElementById('last').innerHTML = '<span class="err">يوجد خطأ مسجل</span>';
            document.getElementById('lastRaw').textContent = last;
          }
        }
        // summary
        const usersArr = users ? safeParse(users) : [];
        if (!usersArr || usersArr.length === 0) {
          document.getElementById('summary').innerHTML = '<span class="warn">لا يوجد مستخدمون محليين. قد يكون seeding لم يعمل.</span>';
        } else {
          document.getElementById('summary').innerHTML = '<span class="ok">المستخدمون المحليون موجودون. حاول تسجيل الدخول الآن.</span>';
        }
      } catch (e) {
        document.getElementById('summary').innerHTML = '<span class="err">فشل قراءة التخزين المحلي</span>';
        document.getElementById('lastRaw').textContent = e && e.message ? e.message : String(e);
      }
    }
    document.getElementById('refreshBtn').addEventListener('click', show);
    show();
  </script>
</body>
</html>
